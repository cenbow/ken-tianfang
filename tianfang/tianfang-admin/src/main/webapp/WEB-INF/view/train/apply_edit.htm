<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>报名新增页面 - Ace Admin</title>
		<meta name="description" content="Common form elements and layouts" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<#include "../admin/head.htm"/>
	</head>
	<body>
		<div class="container-fluid" id="main-container">
			<div id="main-content" class="clearfix" style="margin-left:0px;">
					<div id="page-content" class="clearfix">
						<div class="row-fluid">
							<!-- PAGE CONTENT BEGINS HERE -->
							<form id="submitForm" class="form-horizontal" action="${base}/train/saveNew.do" method="POST">
							<input type="hidden" id="id" name="id" value="${(trainApplyDto.id)!}"/>
								<!-- <input type="hidden" id="marked" name="marked" value="0"/>
								<input type="hidden" id="content" name="content" value=""/>
								<input type="hidden" id="microPic" name="microPic" value=""/> -->
								<div class="control-group">
									<label class="control-label" for="pname">家长姓名</label>
									<div class="controls">
										<input type="text" name="pname" class="span3" id="pname" placeholder="家长姓名" value="${(trainApplyDto.pname)!}">
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="mobile">手机</label>
									<div class="controls">
										<input type="text" name="mobile" class="span3" id="mobile" placeholder="手机" value="${(trainApplyDto.mobile)!}">
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="cname">孩子姓名</label>
									<div class="controls">
										<input type="text" name="cname" class="span3" id="cname" placeholder="孩子姓名" value="${(trainApplyDto.cname)!}">
									</div>
								</div>
									<div class="control-group">
									<label class="control-label" for="courseId">课程</label>
									<div class="controls">
										<!-- <input type="text" name="courseName" class="span7" id=""courseName"" placeholder="课程"> -->
										<select class="chzn-select" name="courseId" id="courseId" data-placeholder="课程" title="课程" style="vertical-align:top;width: 250px;">
										<option value=""></option>
										<option value="">请选择</option>
										</select>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="spaceId">场地</label>
									<div class="controls">
										<!-- <input type="text" name=""spaceName"" class="span7" id="spaceName" placeholder="场地"> -->
										<select name="spaceId" id="spaceId" data-placeholder="场地" title="场地" style="vertical-align:top;width: 250px;">
										<option value=""></option>
										<option value="">请选择</option>
										</select>
									</div>
								</div>
								<div class="control-group" id="times_div" style="display:none;">
									<table class="table">
											 <thead>
										        <tr>
										          <th><label><input id="check-all" type='checkbox' /><span class="lbl"></span></label></th>
										          <th>星期</th>
										          <th>开始时间</th>
										          <th>结束时间</th>
										          <input type="hidden" id = "startTime" name="startTime">
										          <input type="hidden" id = "endTime" name="endTime">
										        </tr>
										     </thead>
										      <tbody id="times_body">
										      <!--   <tr>
										          <th scope="row"><label><input
												name="checkBoxId" value="" type='checkbox' /><span
												class="lbl"></span></label></th>
										          <td>Mark</td>
										          <td>@mdo</td>
										          <td>@mdo</td>
										        </tr> -->
										      </tbody>
										</table>
								</div>
								<div class="control-group">
									<label class="control-label" for="depositIspayed">定金</label>
									<div class="controls">
										<!-- <input type="text" name="cname" class="span3" id="form-field-1" placeholder="定金"> -->
										<select class="chzn-select" name="depositIspayed" id="depositIspayed" data-placeholder="定金" title="定金" style="vertical-align:top;width: 100px;">
											<option value=""></option>
											<option value="">全部</option>
											<option value="1">已支付</option>
											<option value="0">未支付</option>
										</select>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="isPayed">学费</label>
									<div class="controls">
										<!-- <input type="text" name="cname" class="span3" id="form-field-1" placeholder="学费"> -->
										<select class="chzn-select" name="isPayed" id="isPayed" data-placeholder="学费" title="学费" style="vertical-align:top;width: 100px;">
											<option value=""></option>
											<option value="">全部</option>
											<option value="1">已支付</option>
											<option value="0">未支付</option>
										</select>
									</div>
								</div>
								<div class="control-group">
									<label class="control-label" for="applyTimeAdd">报名日期</label>
									<div class="controls">
										<input class="span10 date-picker" name="applyTimeAdd" id="applyTimeAdd"  type="text" data-date-format="yyyy-mm-dd" 
										readonly="readonly" style="width:88px;cursor:pointer;" placeholder="报名日期" title="点击选择报名日期" value="${(trainApplyDto.applyTimeAdd)!}"/>
									</div>
								</div>
								<div class="form-actions">
									<button id='savebutton' class="btn btn-info" type="button"><i class="icon-ok"></i>保存</button>
									&nbsp; &nbsp; &nbsp;
									<button class="btn" type="reset" id="close"><i class="icon-undo"></i>关闭</button>
								</div>
							 </form>
							<!-- PAGE CONTENT ENDS HERE -->
						 </div><!--/row-->
					</div><!--/#page-content-->
			</div><!-- #main-content -->
		</div><!--/.fluid-container#main-container-->
		<a href="#" id="btn-scroll-up" class="btn btn-small btn-inverse">
			<i class="icon-double-angle-up icon-only"></i>
		</a>
		<!-- basic scripts -->
		<script src="${base}/static/1.9.1/jquery.min.js"></script>
		<script type="text/javascript">
		window.jQuery || document.write("<script src='${base}/static/js/jquery-1.9.1.min.js'>\x3C/script>");
		</script>
		
		<script src="${base}/static/js/bootstrap.min.js"></script>
		<!-- page specific plugin scripts -->
		
		<!--[if lt IE 9]>
		<script type="text/javascript" src="${base}/static/js/excanvas.min.js"></script>
		<![endif]-->
		<script type="text/javascript" src="${base}/static/js/jquery-ui-1.10.2.custom.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/jquery.ui.touch-punch.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/chosen.jquery.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/fuelux.spinner.js"></script>
		<script type="text/javascript" src="${base}/static/js/bootstrap-datepicker.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/bootstrap-timepicker.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/date.js"></script>
		<script type="text/javascript" src="${base}/static/js/daterangepicker.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/bootstrap-colorpicker.min.js"></script>
		<script type="text/javascript" src="${base}/static/js/jquery.autosize-min.js"></script>
		<script type="text/javascript" src="${base}/static/js/jquery.inputlimiter.1.3.1.min.js"></script>
		<!-- ace scripts -->
		<script src="${base}/static/js/ace-elements.min.js"></script>
		<script src="${base}/static/js/ace.min.js"></script>
		<!-- inline scripts related to this page -->

    <script type="text/javascript" charset="utf-8" src="${base}/plugins/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="${base}/plugins/ueditor/ueditor.all.min.js"> </script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="${base}/plugins/ueditor/lang/zh-cn/zh-cn.js"></script>
		
		<!-- layer 弹出框处理 -->
		<script type="text/javascript" src="${base}/plugins/layer2.0/layer.js"></script>
		
		<script type="text/javascript">
		/* UE.getEditor('editor'); */
		
	       $("#depositIspayed option").each(function() {
	    	   //alert("aaa"+$(this).val());
	    	   //alert("bbb"+"${(trainApplyDto.depositIspayed)!}");
	    	   if ($(this).val() == "${(trainApplyDto.depositIspayed)!}") {
	    	  	 $(this).attr("selected", "selected");
	    	   } 
	       });
		
	       $("#isPayed option").each(function() {
	    	   if ($(this).val() == "${(trainApplyDto.isPayed)!}") {
	    	  	 $(this).attr("selected", "selected");
	    	   } 
	       });
		
		$(function() {
			//下拉框里课程显示
			$.ajax({
	             type: "POST",
	             url: "${base}/course/findAllCourse.do",
	             data: null,
	             async:false,
	             dataType: "json",
	             success: function(data){
	            	 //console.log(data);
	            	 console.log("${(trainApplyDto.courseId)!}");
	             	  if(data!=null){
	            		 $.each(data, function(k,v) {
	            			    //console.log("v.id = " + v.id + "v.name = "+v.name);
	            			    var courseId = "${(trainApplyDto.courseId)!}";
	                          	if(courseId==v.id){
	            			    	$("#courseId").append("<option selected value=" + v.id + ">" + v.name + "</option>");
	            			    }else{
	            			    	$("#courseId").append("<option value=" + v.id + ">" + v.name + "</option>");
	            			    }	                            
	                     });
	            	 };    
	            	 
	     			//下拉框
	      			$(".chzn-select").chosen(); 
	      			$(".chzn-select-deselect").chosen({allow_single_deselect:true});	            	 
	             }
	         }); 
			 //下拉框里场地显示
			$('#courseId').on("change",function(){
				    var courseId = $("#courseId").val();
				    //var courseName = $("#courseName").val();
				    //alert(courseId);
                	if(courseId == null){
                		return ;
                	}
                	
                	$("#spaceId").empty();
                	$("#spaceId").append("<option value=" + "" + "></option>");
                	$("#spaceId").append("<option value=" + '' + ">请选择</option>");
        			$.ajax({
        	             type: "POST",
        	             url: "${base}/course/findSpaceByCourseId.do",
        	             data: {courseId:courseId},
        	             async:false,
        	             dataType: "json",
        	             success: function(data){
        	             	  if(data!=null){
        	             		  //console.log("${(trainApplyDto.spaceId)!}");
        	            		 $.each(data, function(k,v) {
        	            			    //console.log("v.id = " + v.id + "v.place = "+v.place);
        	            			    //var spaceId = "${(trainApplyDto.spaceId)!}";
        	            			    //alert("spaceId = " + spaceId);
        	            			    //if(spaceId==v.id){
        	            			    //	$("#spaceId").append("<option selected value=" + v.id + ">" + v.place + "</option>");	
        	            			    //}else{
        	            			    //	$("#spaceId").append("<option value=" + v.id + ">" + v.place + "</option>");
        	            			   // }
        	            			 $("#spaceId").append("<option value=" + v.id + ">" + v.place + "</option>");
        	                            
        	                     });
        	            	 };
        	            	//下拉框
     	          			$(".chzn-select").chosen(); 
    	          			$(".chzn-select-deselect").chosen({allow_single_deselect:false});        	            	 
        	             }
        	         }); 
			}); 
			//时间段显示
			$('#spaceId').on("change",function() {
				var spaceId = $("#spaceId").val();
				$.ajax({
					type : "POST",
					url : "${base}/assistant/selectTime.do",
					data : {spaceId:spaceId},
					datatype : "json",// "xml", "html", "script", "json", "jsonp", "text".
					beforeSend : function() {
						$("#times_div").hide();
					},
					success : function(data) {// 成功返回之后调用的函数
						$("#times_div").show();
						if(data.status==200){
							var jsondata = data.data;// eval('(' + data + ')');
							var html = '';
							for(var i =0;i<jsondata.length;i++){
								var day_of_week = jsondata[i].day_of_week;
								var start_time = jsondata[i].start_time;
								var end_time = jsondata[i].end_time;
								var place = jsondata[i].place;
								var addressId = jsondata[i].addressId;
								var traTimeAddress = jsondata[i].traTimeAddress;
								
								$("#startTime").val(start_time);
								$("#endTime").val(end_time);
								
								html += '<tr><th scope=\"row\"><label>';
								html += ' <input name=\"checkBoxId\" type=\"checkbox\" day_of_week=\"'+day_of_week+'\" start_time=\"'+start_time+'\" end_time=\"'+end_time+'\" place=\"'+place+'\" addressId=\"'+addressId+'\" traTimeAddress=\"'+traTimeAddress+'\"/>';
								html += '<span class="lbl"></span></label></th>';
								html += '<td>'+day_of_week+'</td>';
								html += '<td>'+start_time+'</td>';
								html += '<td>'+end_time+'</td>';
								html += '</tr>'
							}
							
							$("#times_body").html(html);
							
							// chkItem事件
				            $("[name = checkBoxId]:checkbox").on("click", function () {
				                var $chk = $("[name = checkBoxId]:checkbox");
				                $("#check-all").attr("checked", $chk.length == $chk.filter(":checked").length);
				            })
						}
					},
					error : function() {// 调用出错执行的函数
					}
				});
				
			});
			 //其他下拉列表框回显
			 //var depositIspayed = "${(trainApplyDto.depositIspayed)!}";
			/* 	 var options = $("#depositIspayed").find("option"); // select下所有的option
		       for(var i=0;i<options.length;i++){
		              if(options[i].value == depositIspayed){
		            	 this.attr("selected", true);
		              }
		       } */

			/* $("#form-radio-show label input").on('click',function(){
				$("#marked").val($(this).val());
			}); */
			$("#savebutton").on('click',function(){
				/* var content = UE.getEditor('editor').getContent();
				//debugger;
				var micro_pic = $("#id-input-file-3").parent().find("img:first").css("background-image");
				$("#content").val(content);
				$("#microPic").val(micro_pic); */
				//校验
				var pname = $("#pname").val() ;
				if (pname == null || pname=="" ) {
	                layer.msg("家长姓名不能为空！");  
	                return;              
	            };
	            
	            var phone_reg = /^(((13[0-9]{1})|147|(15[0-3]{1})|(15[5-9]{1})|(18[0-3]{1})|(18[5-9]{1}))+\d{8})$/;	
	            var mobile = $("#mobile").val() ;
	            if (mobile == null || mobile=="" ) {
	                layer.msg("手机不能为空！");  
	                return;              
	            };
	            if (!phone_reg.test(mobile) && !phone_reg.test(mobile)) {
	            	 layer.msg("手机格式错误！")
	    			//$("#userAccount").focus(); 	
	    			return false;
	    		}
				var courseId = $("#courseId").val() ;
				if (courseId == null || courseId=="" ) {
	                layer.msg("课程不能为空！");  
	                return;              
	            };
	            
				var spaceId = $("#spaceId").val() ;
				if (spaceId == null || spaceId=="" ) {
	                layer.msg("场地不能为空！");  
	                return;              
	            };
	            
				var depositIspayed = $("#depositIspayed").val() ;
				if (depositIspayed == null || depositIspayed=="" ) {
	                layer.msg("定金状态不能为空！");  
	                return;              
	            };
	            
				var isPayed = $("#isPayed").val() ;
				if (isPayed == null || isPayed=="" ) {
	                layer.msg("费用支付状态不能为空！");  
	                return;              
	            };
	            
	            var applyTimeAdd = $("#applyTimeAdd").val() ;
				if (applyTimeAdd == null || applyTimeAdd=="" ) {
	                layer.msg("报名日期不能为空！");  
	                return;              
	            };
				
	            var $chk =$("input[type='checkbox']:checked");
				//alert("选择的长度为："+$chk.length);
	            if ($chk.length != 1 ){
	            	layer.msg("请选择一个时间段！");
	            	return;
	            }else{
	            	var startTime = $chk.attr("start_time");
			    	var endTime = $chk.attr("end_time");
			    	$("#startTime").val(startTime);
			    	$("#endTime").val(endTime);
	            }
				var ajaxParams = $("#submitForm").serialize();
				$.ajax({
					type : "POST",
					url : "${base}/apply/update.do",
					data : ajaxParams,
					datatype : "json",// "xml", "html", "script", "json", "jsonp", "text".
					beforeSend : function() {
						$("#msg").html("logining");
					},
					success : function(data) {// 成功返回之后调用的函数
						//console.log(data);
						var data = eval('(' + data + ')');
						if(data.message == "200"){
							parent.layer.msg('保存成功', {
								shade: [0.9, '#000'],
							    icon: 6,
							    time: 1500 //2秒关闭（如果不配置，默认是3秒）
							}, function(){
								parent.reload_page();
								var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
								parent.layer.close(index);
							}); 							
						}else{
							parent.layer.msg('保存出错', {
								shade: [0.9, '#000'],
							    icon: 6,
							    time: 1500 //2秒关闭（如果不配置，默认是3秒）
							}, function(){
							}); 	
						}
						//console.log(data.success);
					},
					complete : function(XMLHttpRequest, textStatus) {// 调用执行后调用的函数
						
					},
					error : function() {// 调用出错执行的函数
					}
				});
			});
							
			$('#id-input-file-1 , #id-input-file-2').ace_file_input({
				no_file:'No File ...',
				btn_choose:'Choose',
				btn_change:'Change',
				droppable:false,
				onchange:null,
				thumbnail:false //| true | large
				//whitelist:'gif|png|jpg|jpeg'
				//blacklist:'exe|php'
				//onchange:''
				//
			});
			
			$('#id-input-file-3').ace_file_input({
				style:'well',
				btn_choose:'点击上传图片文件',
				btn_change:null,
				no_icon:'icon-cloud-upload',
				droppable:true,
				onchange:null,
				thumbnail:'small',
				before_change:function(files, dropped) {
					//console.log(files);
					//console.log(dropped);
					/**
					if(files instanceof Array || (!!window.FileList && files instanceof FileList)) {
						//check each file and see if it is valid, if not return false or make a new array, add the valid files to it and return the array
						//note: if files have not been dropped, this does not change the internal value of the file input element, as it is set by the browser, and further file uploading and handling should be done via ajax, etc, otherwise all selected files will be sent to server
						//example:
						var result = []
						for(var i = 0; i < files.length; i++) {
							var file = files[i];
							if((/^image\//i).test(file.type) && file.size < 102400)
								result.push(file);
						}
						return result;
					}
					*/
					return true;
				}
				/*,
				before_remove : function() {
					return true;
				}*/
			}).on('change', function(){
				//console.log($(this).data('ace_input_files'));
				//console.log($(this).data('ace_input_files'));
				//console.log($(this).data('ace_input_method'));
			});
			
			//日期框
			$('.date-picker').datepicker();	
			
			//下拉框
 			$(".chzn-select").chosen(); 
 			$(".chzn-select-deselect").chosen({allow_single_deselect:true});
			
		});
		</script>
	</body>
</html>
